<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GConnect — Chess Analysis Board</title>

  <!-- Chessboard.js CSS -->
  <link rel="stylesheet"
        href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
        crossorigin="anonymous">

  <!-- Bootstrap CSS (for basic layout) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"/>

  <style>
    :root{
      --bg:#0f1416; --card:#13181a; --muted:#9aa4a8; --accent:#00b894;
    }
    html,body{height:100%;background:var(--bg);color:#e6eef0;font-family:Inter,Helvetica,Arial,sans-serif;margin:0;padding:0;}
    .container{padding:18px;max-width:1200px;margin:0 auto;}
    h3{margin-bottom:12px;}
    .card{background:var(--card);border:none;border-radius:12px;color:inherit;box-shadow:0 6px 18px rgba(0,0,0,.6);}
    textarea{background:transparent;border:1px solid #223;min-height:110px;color:inherit;padding:12px;border-radius:8px;width:100%;}
    .progress {height:10px;background:#0a0d0e;border-radius:6px;overflow:hidden;}
    .progress-bar{background:linear-gradient(90deg,#00b894,#2dd4bf);}

    /* layout */
    .grid{display:grid;grid-template-columns: 1fr 420px;gap:18px;}
    @media (max-width:1000px){ .grid{grid-template-columns:1fr;} }

    /* board container */
    #board { width: 100%; max-width: 420px; margin: 0 auto; }

    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;justify-content:center;}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:#e6eef0;}
    .meta{color:var(--muted);font-size:.9rem;margin-top:8px;}

    /* move list / card */
    .move-card{margin-bottom:8px;border-radius:10px;padding:10px;background:#0f1718;display:flex;align-items:center;gap:10px;cursor:pointer;}
    .move-cat{font-weight:700;padding:6px 8px;border-radius:6px;font-size:.8rem;display:inline-flex;align-items:center;gap:8px;}
    .cat-Brilliant{background:#ffdd57;color:#1f1a00;}
    .cat-Great{background:#b6f19c;color:#05320a;}
    .cat-Best{background:#9ad0ff;color:#01243a;}
    .cat-Mistake{background:#ffd1a8;color:#3a1700;}
    .cat-Miss{background:#ffd1a8;color:#3a1700;}
    .cat-Blunder{background:#ff9aa2;color:#3a0006;}
    .cat-Inaccuracy{background:#f0f0f0;color:#222;}
    .cat-Equal{background:#222;color:#ddd;}

    .analysis-text{color:#dfeff0;margin-top:6px;white-space:pre-wrap;}

    /* player avatars */
    .player-box{display:flex;gap:10px;align-items:center;margin-top:8px}
    .player-avatar{width:48px;height:48px;border-radius:50%;overflow:hidden;flex-shrink:0}
    .player-avatar img{width:100%;height:100%;object-fit:cover}

    .small-muted{color:var(--muted);font-size:.85rem;}
    .stat-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .stat-pill{background:#0c1716;padding:6px 8px;border-radius:999px;font-weight:600;font-size:.9rem}

    /* cat icon */
    .cat-icon{width:22px;height:22px;border-radius:50%;display:inline-block;overflow:hidden;flex-shrink:0}
    .cat-icon img{width:100%;height:100%;object-fit:cover}

    /* small responsive tweaks */
    .controls .btn{font-size:.9rem;padding:.35rem .6rem;}
  </style>
</head>
<body>
  <div class="container">
    <h3>GConnect — Chess Analysis Board</h3>

    <div class="card p-3 mb-3">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
        <div style="flex:1;">
          <div class="small-muted">PGN পেস্ট করুন (header included হলে player নামও পড়ে নিবে)</div>
          <textarea id="pgnInput" placeholder='উদাহরণ:
[Event "Game"]
[White "player1"]
[Black "player2"]
1. e4 e5 2. Nf3 Nc6 3. Bb5 a6 ...'></textarea>
        </div>
        <div style="width:300px;">
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button id="analyzeBtn" class="btn btn-success">Analyze PGN</button>
            <button id="clearBtn" class="btn btn-ghost">Clear</button>
            <div id="pgnMeta" class="meta"></div>
            <div class="small-muted" style="margin-top:8px">Pieces are loaded from local <code>./pieces/{piece}.svg</code> (e.g. wK.svg bP.svg).</div>
            <div class="small-muted">Category icons are from CDN (Bootstrap Icons).</div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- left: board + current analysis -->
      <div>
        <div class="card p-3 mb-3">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h5 style="margin:0">Board</h5>
            <div class="small-muted" id="moveIndex">Move 0 / 0</div>
          </div>

          <div style="display:flex;gap:12px;align-items:flex-start;margin-top:10px;">
            <div id="board"></div>

            <div style="flex:1;">
              <div class="controls">
                <button id="firstBtn" class="btn btn-ghost">⏮ First</button>
                <button id="prevBtn" class="btn btn-ghost">◀ Prev</button>
                <button id="nextBtn" class="btn btn-ghost">Next ▶</button>
                <button id="lastBtn" class="btn btn-ghost">Last ⏭</button>
                <button id="undoBtn" class="btn btn-ghost">Undo ↶</button>
                <button id="redoBtn" class="btn btn-ghost">Redo ↷</button>
              </div>

              <div style="margin-top:10px;">
                <div class="small-muted">AI evaluation for current move</div>
                <div class="card p-2 mt-2" style="background:#0d1415;">
                  <div id="currentCategory" style="display:inline-block"></div>
                  <div id="currentComment" class="analysis-text">No analysis yet.</div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- right: progress + players + move-list summary -->
      <div>
        <div class="card p-3 mb-3">
          <h5 style="margin:0">Analysis Progress</h5>
          <div style="margin-top:10px;">
            <div class="progress"><div id="progressBar" class="progress-bar" style="width:0%"></div></div>
            <div id="progressText" class="small-muted" style="margin-top:8px;">Idle</div>
          </div>
        </div>

        <div class="card p-3 mb-3">
          <h5 style="margin:0">Players & Stats</h5>
          <div id="playersCard" style="margin-top:8px">
            <div class="player-box">
              <div class="player-avatar"><img id="whiteAvatar" src="https://picsum.photos/seed/white/64" alt="white"/></div>
              <div style="flex:1">
                <div><strong id="whiteName">White</strong></div>
                <div class="small-muted" id="whiteAccuracy">Accuracy: —</div>
                <div class="stat-row" id="whiteStats"></div>
              </div>
            </div>

            <hr style="border-color:#0b1514;margin:10px 0"/>

            <div class="player-box">
              <div class="player-avatar"><img id="blackAvatar" src="https://picsum.photos/seed/black/64" alt="black"/></div>
              <div style="flex:1">
                <div><strong id="blackName">Black</strong></div>
                <div class="small-muted" id="blackAccuracy">Accuracy: —</div>
                <div class="stat-row" id="blackStats"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card p-3 mb-3">
          <h5 style="margin:0">Moves (click to jump)</h5>
          <div class="small-muted" style="margin-top:6px">কমেন্ট বোর্ডের নীচে দেখবে, এখানে ক্লিক করে অবস্থানে যাবে</div>
          <div id="movesList" style="margin-top:12px;max-height:420px;overflow:auto;padding-right:6px;"></div>
        </div>

        <div class="card p-3">
          <h5 style="margin:0">Summary</h5>
          <div id="summaryBox" class="small-muted" style="margin-top:8px;">No summary yet.</div>
        </div>

      </div>
    </div>

  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- Chessboard.js -->
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" crossorigin="anonymous"></script>
  <!-- bootstrap bundle (optional) -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
  <!-- local chess.js (must be placed in same directory) -->
  <script src="./chess.js"></script>

  <script>
    // Category icons (Bootstrap Icons CDN via jsDelivr)
    const categoryIconMap = {
      'Brilliant': 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/star-fill.svg',
      'Great': 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/trophy-fill.svg',
      'Best': 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/check-circle-fill.svg',
      'Inaccuracy': 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/dash-circle-fill.svg',
      'Mistake': 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/exclamation-triangle-fill.svg',
      'Miss': 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/question-circle-fill.svg',
      'Blunder': 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/x-circle-fill.svg',
      'Equal': 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/record-circle-fill.svg'
    };

    // App state
    let boardWidget = null;
    let movesSAN = []; // half-moves SAN
    let fens = []; // fen per half-move (0 = start)
    let analysisResults = []; // per half-move {category, score, comment}
    let currentIndex = 0; // 0..fens.length-1
    let undoStack = [], redoStack = [];

    // DOM refs
    const pgnInput = document.getElementById('pgnInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const movesList = document.getElementById('movesList');
    const currentCategory = document.getElementById('currentCategory');
    const currentComment = document.getElementById('currentComment');
    const moveIndexEl = document.getElementById('moveIndex');
    const pgnMeta = document.getElementById('pgnMeta');
    const summaryBox = document.getElementById('summaryBox');

    const whiteNameEl = document.getElementById('whiteName');
    const blackNameEl = document.getElementById('blackName');
    const whiteAvatar = document.getElementById('whiteAvatar');
    const blackAvatar = document.getElementById('blackAvatar');
    const whiteAccuracyEl = document.getElementById('whiteAccuracy');
    const blackAccuracyEl = document.getElementById('blackAccuracy');
    const whiteStatsEl = document.getElementById('whiteStats');
    const blackStatsEl = document.getElementById('blackStats');

    // control buttons
    const firstBtn = document.getElementById('firstBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const lastBtn = document.getElementById('lastBtn');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');

    // Initialize board: use local pieces folder (./pieces/{piece}.svg)
    function initBoard(){
      if(boardWidget && typeof boardWidget.destroy === 'function') boardWidget.destroy();
      boardWidget = Chessboard('board', {
        draggable: false,
        position: 'start',
        pieceTheme: './pieces/{piece}.svg' // expects wK.svg, bP.svg etc in ./pieces/
      });
    }
    initBoard();

    // Parse PGN headers
    function parseHeaders(pgn){
      const headers = {};
      const re = /^\[([A-Za-z0-9_]+)\s+"([^"]*)"\]/gm;
      let m;
      while((m = re.exec(pgn)) !== null){
        headers[m[1]] = m[2];
      }
      return headers;
    }

    // Parse PGN and produce moves + fens
    function parsePGNandBuild(pgn){
      const temp = new Chess();
      const ok = temp.load_pgn(pgn);
      if(!ok) throw new Error('Invalid PGN: could not load');
      const historySAN = temp.history(); // half-move SAN array
      const headers = parseHeaders(pgn);
      const g = new Chess();
      if(headers.SetUp === '1' && headers.FEN){
        const loaded = g.load(headers.FEN);
        if(!loaded) g.reset();
      } else {
        g.reset();
      }
      const fensLocal = [g.fen()];
      const movesLocal = [];
      for(const san of historySAN){
        const res = g.move(san);
        if(!res) throw new Error('Failed to apply move: ' + san);
        movesLocal.push(san);
        fensLocal.push(g.fen());
      }
      return { headers, movesSAN: movesLocal, fens: fensLocal };
    }

    // UI helpers
    function setProgress(pct, text){
      progressBar.style.width = pct + '%';
      progressText.textContent = text;
    }

    function escapeHtml(s){
      if(!s) return '';
      return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];});
    }

    // Build system/user messages for the model
    function buildMessages(fen, san, plyIndex){
      const system = {
        role: "system",
        content: `You are GConnect Chess Analysis Assistant.
Return EXACTLY one JSON object and nothing else. JSON keys: category, score, comment.
category must be one of ["Brilliant","Great","Best","Inaccuracy","Mistake","Miss","Blunder","Equal"].
score: integer centipawn or null.
comment: concise (max 2 sentences) constructive message. For positive moves (Brilliant/Great/Best), add a short encouraging one-liner.`
      };
      const user = {
        role: "user",
        content: `Position FEN: ${fen}
Move SAN: ${san}
Ply index: ${plyIndex}
Please output a single JSON object only.`
      };
      return [system, user];
    }

    // Call server proxy /api/query to analyze one move (with retries)
    async function analyzeMove(fen, san, plyIndex){
      const maxRetries = 3;
      for(let attempt=1; attempt<=maxRetries; attempt++){
        try {
          const body = {
            model: "openai/gpt-oss-120b:together",
            messages: buildMessages(fen, san, plyIndex),
            max_tokens: 300,
            temperature: 0.2
          };
          const resp = await fetch('/api/query', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
          if(!resp.ok) throw new Error('Server error '+resp.status);
          const json = await resp.json();
          // try to get reply text
          let txt = '';
          if(json.replyText) txt = json.replyText;
          else if(json.result && json.result.choices && json.result.choices[0] && json.result.choices[0].message) txt = json.result.choices[0].message.content || '';
          else if(typeof json === 'string') txt = json;
          // extract JSON substring
          let parsed = null;
          try { parsed = JSON.parse(txt.trim()); }
          catch(e){
            const m = txt.match(/\{[\s\S]*\}/);
            if(m){
              try { parsed = JSON.parse(m[0]); } catch(e2){ parsed = null; }
            }
          }
          if(parsed && typeof parsed === 'object'){
            const category = (parsed.category || 'Equal').toString().trim();
            const score = (typeof parsed.score === 'number') ? parsed.score : (parsed.score ? Number(parsed.score) : null);
            let comment = (parsed.comment || '').toString().trim();
            comment = comment.replace(/^[\s"'`]+|[\s"'`]+$/g,'');
            const sentences = comment.split(/(?<=\.)\s+/);
            comment = sentences.slice(0,2).join(' ').trim();
            if(['Brilliant','Great','Best'].includes(category)){
              if(!/well|good|strong|brilliant|excellent|great/i.test(comment)){
                comment += ' Great idea — well played!';
              }
            }
            return { category, score, comment };
          } else {
            // fallback: return raw trimmed text as comment
            let fallback = (txt || '').toString().trim().replace(/\s+/g,' ').slice(0,500);
            fallback = fallback.replace(/^[\s"']+|[\s"']+$/g,'');
            return { category: 'Equal', score: null, comment: fallback || 'No clear analysis.' };
          }
        } catch(err){
          console.warn('analyzeMove attempt', attempt, 'failed:', err);
          if(attempt === maxRetries) return { category:'Equal', score:null, comment: 'Analysis failed.' };
          await new Promise(r=>setTimeout(r, 500 * attempt));
        }
      }
      return { category:'Equal', score:null, comment:'Analysis unavailable.' };
    }

    // Render moves list on right
    function renderMovesList(){
      movesList.innerHTML = '';
      for(let i=0;i<movesSAN.length;i++){
        const ply = i+1;
        const san = movesSAN[i];
        const analysis = analysisResults[i] || {};
        const cat = analysis.category || '—';
        const comment = (analysis.comment || '').slice(0,120);
        const iconUrl = categoryIconMap[cat] || categoryIconMap['Equal'];
        const el = document.createElement('div');
        el.className = 'move-card';
        el.innerHTML = `
          <div style="width:44px;display:flex;flex-direction:column;align-items:center;">
            <div style="font-size:.9rem">${ply}</div>
            <div style="font-size:.75rem;color:var(--muted)">${(ply%2===1)?'W':'B'}</div>
          </div>
          <div style="width:40px;display:flex;align-items:center;justify-content:center;">
            <div class="cat-icon"><img src="${iconUrl}" alt="${escapeHtml(cat)}"></div>
          </div>
          <div style="flex:1">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong>${escapeHtml(san)}</strong></div>
              <div><span class="move-cat cat-${String(cat).replace(/\s+/g,'')}">${escapeHtml(cat)}</span></div>
            </div>
            <div class="analysis-text" style="font-size:.9rem;color:#cfeee0">${escapeHtml(comment)}</div>
          </div>
        `;
        el.onclick = ()=> setPosition(ply);
        movesList.appendChild(el);
      }
    }

    // Update board & current analysis UI
    function updateUI(){
      moveIndexEl.textContent = `Move ${currentIndex} / ${Math.max(0, fens.length-1)}`;
      const fen = fens[currentIndex] || 'start';
      boardWidget.position(fen);
      if(currentIndex === 0){
        currentCategory.innerHTML = '';
        currentComment.textContent = 'Start position.';
      } else {
        const analysis = analysisResults[currentIndex-1] || {category:'—', comment:'Waiting...' };
        const cat = analysis.category || '—';
        const icon = categoryIconMap[cat] || categoryIconMap['Equal'];
        currentCategory.innerHTML = `<span class="move-cat cat-${String(cat).replace(/\s+/g,'')}"><span class="cat-icon" style="margin-right:6px;"><img src="${icon}" alt="${escapeHtml(cat)}"></span> ${escapeHtml(cat)}</span>`;
        currentComment.textContent = analysis.comment || 'Waiting for analysis...';
      }
      // highlight current in move list
      Array.from(movesList.children).forEach((el, idx) => {
        if(idx+1 === currentIndex) el.style.outline = '2px solid rgba(255,255,255,.04)';
        else el.style.outline = 'none';
      });
    }

    function setPosition(idx){
      if(idx < 0) idx = 0;
      if(idx > fens.length-1) idx = fens.length-1;
      undoStack.push(currentIndex);
      currentIndex = idx;
      redoStack = [];
      updateUI();
    }

    // Navigation buttons
    firstBtn.onclick = ()=> setPosition(0);
    lastBtn.onclick = ()=> setPosition(Math.max(0, fens.length-1));
    prevBtn.onclick = ()=> setPosition(Math.max(0, currentIndex-1));
    nextBtn.onclick = ()=> setPosition(Math.min(fens.length-1, currentIndex+1));
    undoBtn.onclick = ()=> { if(undoStack.length){ redoStack.push(currentIndex); currentIndex = undoStack.pop(); updateUI(); } };
    redoBtn.onclick = ()=> { if(redoStack.length){ undoStack.push(currentIndex); currentIndex = redoStack.pop(); updateUI(); } };

    // Compute stats (counts and simple accuracy) and render players card
    function computeStatsAndRender(){
      const whiteCounts = {}; const blackCounts = {};
      const allCats = ['Brilliant','Great','Best','Inaccuracy','Mistake','Miss','Blunder','Equal'];
      allCats.forEach(c=>{ whiteCounts[c]=0; blackCounts[c]=0; });
      for(let i=0;i<analysisResults.length;i++){
        const a = analysisResults[i] || { category:'Equal' };
        const cat = a.category || 'Equal';
        const ply = i+1;
        if(ply % 2 === 1) whiteCounts[cat] = (whiteCounts[cat]||0)+1;
        else blackCounts[cat] = (blackCounts[cat]||0)+1;
      }
      const whiteTotal = Object.values(whiteCounts).reduce((s,v)=>s+v,0) || 0;
      const blackTotal = Object.values(blackCounts).reduce((s,v)=>s+v,0) || 0;
      const whiteErrors = (whiteCounts['Mistake']||0) + (whiteCounts['Miss']||0) + (whiteCounts['Blunder']||0);
      const blackErrors = (blackCounts['Mistake']||0) + (blackCounts['Miss']||0) + (blackCounts['Blunder']||0);
      const whiteAcc = whiteTotal ? Math.max(0, Math.round((1 - (whiteErrors/whiteTotal))*100)) : '—';
      const blackAcc = blackTotal ? Math.max(0, Math.round((1 - (blackErrors/blackTotal))*100)) : '—';
      whiteAccuracyEl.textContent = `Accuracy: ${whiteAcc === '—' ? '—' : whiteAcc + '%'}`;
      blackAccuracyEl.textContent = `Accuracy: ${blackAcc === '—' ? '—' : blackAcc + '%'}`;
      whiteStatsEl.innerHTML = '';
      blackStatsEl.innerHTML = '';
      allCats.forEach(c=>{
        if(whiteCounts[c]){
          const el = document.createElement('div'); el.className='stat-pill'; el.textContent = `${c}: ${whiteCounts[c]}`; whiteStatsEl.appendChild(el);
        }
        if(blackCounts[c]){
          const el2 = document.createElement('div'); el2.className='stat-pill'; el2.textContent = `${c}: ${blackCounts[c]}`; blackStatsEl.appendChild(el2);
        }
      });
      const totalMoves = analysisResults.length;
      summaryBox.textContent = `Total half-moves: ${totalMoves} • White moves: ${whiteTotal} • Black moves: ${blackTotal}`;
    }

    // MAIN: analyze button flow
    analyzeBtn.onclick = async ()=>{
      const pgn = pgnInput.value.trim();
      if(!pgn){ alert('প্রথমে PGN পেস্ট করুন।'); return; }
      try {
        setProgress(2, 'Parsing PGN...');
        const res = parsePGNandBuild(pgn);
        movesSAN = res.movesSAN;
        fens = res.fens;
        analysisResults = new Array(movesSAN.length).fill(null);
        currentIndex = 0;
        initBoard();
        boardWidget.position(fens[0]);
        updateUI();

        // headers → show players & avatars (placeholder via picsum)
        pgnMeta.textContent = `${res.headers.White || 'White'} vs ${res.headers.Black || 'Black'} • Moves: ${movesSAN.length}`;
        whiteNameEl.textContent = res.headers.White || 'White';
        blackNameEl.textContent = res.headers.Black || 'Black';
        whiteAvatar.src = `https://picsum.photos/seed/${encodeURIComponent(res.headers.White||'white')}/64`;
        blackAvatar.src = `https://picsum.photos/seed/${encodeURIComponent(res.headers.Black||'black')}/64`;

        // iterate moves sequentially (keeps memory low, easy to show progress)
        for(let i=0;i<movesSAN.length;i++){
          const ply = i+1;
          const pct = Math.round(((i+1) / movesSAN.length) * 100);
          setProgress(pct, `Analyzing move ${ply} / ${movesSAN.length} ...`);
          const fenBefore = fens[i];
          const san = movesSAN[i];
          const out = await analyzeMove(fenBefore, san, ply);
          analysisResults[i] = out;
          renderMovesList();
          computeStatsAndRender();
          // if currently viewing that move, refresh UI
          updateUI();
        }
        setProgress(100, 'Analysis complete');
        renderMovesList();
        computeStatsAndRender();
        updateUI();
      } catch(err){
        console.error(err);
        alert('Analysis failed: ' + (err.message || err));
        setProgress(0, 'Failed');
      }
    };

    // Clear button
    clearBtn.onclick = ()=>{
      pgnInput.value = '';
      pgnMeta.textContent = '';
      movesSAN = []; fens = []; analysisResults = []; currentIndex = 0;
      movesList.innerHTML = '';
      initBoard();
      setProgress(0, 'Idle');
      summaryBox.textContent = 'No summary yet.';
      currentCategory.innerHTML = '';
      currentComment.textContent = 'No analysis yet.';
      moveIndexEl.textContent = 'Move 0 / 0';
      whiteNameEl.textContent = 'White';
      blackNameEl.textContent = 'Black';
      whiteAvatar.src = 'https://picsum.photos/seed/white/64';
      blackAvatar.src = 'https://picsum.photos/seed/black/64';
      whiteStatsEl.innerHTML = '';
      blackStatsEl.innerHTML = '';
      whiteAccuracyEl.textContent = 'Accuracy: —';
      blackAccuracyEl.textContent = 'Accuracy: —';
    };

    // initial UI
    setProgress(0, 'Idle');
  </script>
</body>
</html>
