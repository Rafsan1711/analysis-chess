<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chess Analysis Board</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />
  <style>
    body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; }
    #board { width: 400px; margin: 20px; }
    #controls { margin: 10px; }
    #info { margin-top: 10px; }
    .highlight { background-color: rgba(255, 255, 0, 0.6); }
  </style>
</head>
<body>
  <h2>Chess Analysis Board</h2>
  <div id="board"></div>

  <div id="controls">
    <button onclick="undoMove()">Undo</button>
    <button onclick="redoMove()">Redo</button>
  </div>

  <div id="info">Best move: <span id="bestmove">N/A</span></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.min.js"></script>

  <script>
    const game = new Chess();
    const board = Chessboard('board', {
      draggable: true,
      position: 'start',
      onDrop: onDrop
    });

    const engine = Stockfish();
    engine.postMessage("uci");

    let undoStack = [];
    let redoStack = [];

    function onDrop(source, target) {
      let move = game.move({ from: source, to: target, promotion: 'q' });
      if (move === null) return 'snapback';
      undoStack.push(move);
      redoStack = [];
      board.position(game.fen());
      highlightMove(move);
      analyzePosition();
    }

    function undoMove() {
      if (undoStack.length === 0) return;
      let move = game.undo();
      redoStack.push(move);
      board.position(game.fen());
    }

    function redoMove() {
      if (redoStack.length === 0) return;
      let move = redoStack.pop();
      game.move(move);
      undoStack.push(move);
      board.position(game.fen());
    }

    function analyzePosition() {
      engine.postMessage("position fen " + game.fen());
      engine.postMessage("go depth 12");

      engine.onmessage = function(event) {
        let line = event.data;
        if (typeof line === "string" && line.startsWith("bestmove")) {
          let best = line.split(" ")[1];
          document.getElementById("bestmove").innerText = best;
          markBestMove(best);
        }
      };
    }

    function highlightMove(move) {
      removeHighlights();
      document.querySelector(`[data-square='${move.from}']`)?.classList.add("highlight");
      document.querySelector(`[data-square='${move.to}']`)?.classList.add("highlight");
    }

    function removeHighlights() {
      document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
    }

    function markBestMove(bestMove) {
      removeHighlights();
      const from = bestMove.substring(0,2);
      const to = bestMove.substring(2,4);
      document.querySelector(`[data-square='${from}']`)?.classList.add("highlight");
      document.querySelector(`[data-square='${to}']`)?.classList.add("highlight");
    }
  </script>
</body>
  </html>
