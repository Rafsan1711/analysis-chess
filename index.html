<!DOCTYPE html>
<html lang="en">
<head>
    <title>ChessMax - Professional Chess Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">

    <!-- External Libraries -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">

    <style>
        :root {
            --primary-bg: #161512;
            --secondary-bg: #262522;
            --panel-bg: #2c2b28;
            --accent-green: #81b64c;
            --accent-blue: #4a9eff;
            --accent-orange: #f1c40f;
            --text-primary: #e8e6e3;
            --text-secondary: #a6a4a1;
            --text-muted: #716f6c;
            --border-color: #3d3c39;
            --light-square: #f0d9b5;
            --dark-square: #b58863;
            --highlight-move: rgba(129, 182, 76, 0.8);
            --highlight-capture: rgba(244, 67, 54, 0.8);
            --highlight-check: rgba(255, 87, 51, 0.9);
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: linear-gradient(135deg, var(--primary-bg) 0%, #1a1916 100%);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            overflow-x: hidden;
        }

        .navbar-custom {
            background: var(--secondary-bg);
            border-bottom: 2px solid var(--border-color);
            backdrop-filter: blur(10px);
            padding: 0.8rem 0;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--accent-green) !important;
        }

        .nav-link {
            color: var(--text-secondary) !important;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem !important;
            border-radius: 6px;
            margin: 0 0.2rem;
            cursor: pointer;
        }

        .nav-link:hover {
            color: var(--text-primary) !important;
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-link.active {
            color: var(--accent-green) !important;
            background: rgba(129, 182, 76, 0.2);
        }

        .main-container {
            min-height: calc(100vh - 80px);
            padding: 2rem 0;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .login-container {
            max-width: 400px;
            margin: 4rem auto;
            text-align: center;
            background: var(--panel-bg);
            padding: 3rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .login-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--accent-green);
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .sidebar {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 1.5rem;
            height: fit-content;
            border: 1px solid var(--border-color);
        }

        .main-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            min-height: 600px;
        }

        .game-mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .game-mode-card {
            background: linear-gradient(135deg, var(--secondary-bg), var(--panel-bg));
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .game-mode-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-green);
            box-shadow: 0 8px 25px rgba(129, 182, 76, 0.3);
        }

        .game-area {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .board-container {
            text-align: center;
        }

        #chessboard, #analysis-board {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .player-info {
            background: var(--panel-bg);
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            height: fit-content;
        }

        .player-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .player-card.current-turn {
            border-color: var(--accent-green);
            box-shadow: 0 0 15px rgba(129, 182, 76, 0.3);
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            overflow: hidden;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-details h4 {
            margin: 0;
            font-size: 1.1rem;
        }

        .player-rating {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .game-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .control-btn {
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--secondary-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
        }

        .control-btn:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .control-btn.danger {
            background: var(--danger);
            border-color: var(--danger);
        }

        .control-btn.danger:hover {
            background: #c0392b;
        }

        .move-history {
            background: var(--secondary-bg);
            border-radius: 8px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            margin: 1rem 0;
        }

        .move-history h5 {
            margin-bottom: 1rem;
            color: var(--accent-green);
        }

        .move-list {
            display: grid;
            grid-template-columns: auto 1fr 1fr;
            gap: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .move-number {
            color: var(--text-secondary);
            text-align: right;
        }

        .move-white, .move-black {
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .move-white:hover, .move-black:hover {
            background: rgba(129, 182, 76, 0.2);
        }

        .move-classification {
            display: inline-block;
            padding: 0.2rem 0.4rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .brilliant { background: #1e90ff; color: white; }
        .great { background: #27ae60; color: white; }
        .best { background: #27ae60; color: white; }
        .good { background: #81b64c; color: white; }
        .book { background: #9b59b6; color: white; }
        .inaccuracy { background: #f39c12; color: white; }
        .mistake { background: #e67e22; color: white; }
        .blunder { background: #e74c3c; color: white; }

        .analysis-panel {
            background: var(--panel-bg);
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            margin: 1rem 0;
        }

        .evaluation-bar {
            width: 100%;
            height: 20px;
            background: linear-gradient(90deg, #000 50%, #fff 50%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin: 1rem 0;
        }

        .eval-indicator {
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            background: var(--accent-green);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .analysis-chart {
            margin: 2rem 0;
            height: 200px;
            background: var(--secondary-bg);
            border-radius: 8px;
            padding: 1rem;
        }

        .progress-bar-container {
            background: var(--secondary-bg);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .btn-custom {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--accent-green), #6da940);
            color: white;
            margin: 0.25rem;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(129, 182, 76, 0.4);
            color: white;
            text-decoration: none;
        }

        .btn-secondary-custom {
            background: linear-gradient(135deg, var(--secondary-bg), var(--panel-bg));
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary-custom:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .btn-danger-custom {
            background: linear-gradient(135deg, var(--danger), #c0392b);
        }

        .btn-danger-custom:hover {
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .modal-content {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
        }

        .modal-header {
            border-bottom: 1px solid var(--border-color);
            background: var(--secondary-bg);
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
        }

        .white-1e1d7 {
            background-color: var(--light-square) !important;
        }

        .black-3c85d {
            background-color: var(--dark-square) !important;
        }

        .square-highlighted {
            box-shadow: inset 0 0 0 4px var(--highlight-move) !important;
        }

        .square-selected {
            box-shadow: inset 0 0 0 4px var(--accent-blue) !important;
        }

        .square-check {
            box-shadow: inset 0 0 0 4px var(--highlight-check) !important;
            animation: checkPulse 1s infinite alternate;
        }

        @keyframes checkPulse {
            0% { box-shadow: inset 0 0 0 4px var(--highlight-check) !important; }
            100% { box-shadow: inset 0 0 0 6px var(--highlight-check) !important; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-card {
            background: var(--secondary-bg);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-green);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .form-control {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
        }

        .form-control:focus {
            background: var(--panel-bg);
            border-color: var(--accent-green);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(129, 182, 76, 0.25);
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .game-area {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            #chessboard, #analysis-board {
                max-width: 400px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 1rem 0;
            }
            
            .game-mode-grid {
                grid-template-columns: 1fr;
            }
            
            #chessboard, #analysis-board {
                max-width: 350px;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--accent-green);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .pgn-input {
            width: 100%;
            min-height: 150px;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        .pgn-input:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 0.2rem rgba(129, 182, 76, 0.25);
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-chess-king"></i> ChessMax</a>
            
            <div class="navbar-nav ml-auto">
                <a class="nav-link active" onclick="showScreen('home')">Home</a>
                <a class="nav-link" onclick="showScreen('play')">Play vs Bot</a>
                <a class="nav-link" onclick="showScreen('analyze')">Analysis Board</a>
                <a class="nav-link" id="user-profile">Profile</a>
                <a class="nav-link" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Login Screen -->
        <div id="login-screen" class="screen active">
            <div class="login-container">
                <h1 class="login-title">Welcome to ChessMax</h1>
                <p class="login-subtitle">Professional Chess Platform</p>
                <div class="text-center">
                    <button class="btn-custom" onclick="signInWithGoogle()">
                        <i class="fab fa-google"></i> Sign in with Google
                    </button>
                </div>
            </div>
        </div>

        <!-- Home Screen -->
        <div id="home-screen" class="screen">
            <div class="container">
                <div class="dashboard">
                    <!-- Left Sidebar -->
                    <div class="sidebar">
                        <h4><i class="fas fa-user-circle"></i> Player Stats</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="user-rating">--</div>
                                <div class="stat-label">Rating</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="games-played">--</div>
                                <div class="stat-label">Games</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="win-rate">--%</div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Panel -->
                    <div class="main-panel">
                        <h2><i class="fas fa-chess"></i> Chess Platform</h2>
                        
                        <!-- Game Mode Selection -->
                        <div class="game-mode-grid">
                            <div class="game-mode-card" onclick="showScreen('play')">
                                <i class="fas fa-robot" style="font-size: 2rem; color: var(--accent-blue); margin-bottom: 1rem;"></i>
                                <h4>Human vs Bot</h4>
                                <p>Challenge Stockfish AI engine</p>
                            </div>
                            <div class="game-mode-card" onclick="showScreen('analyze')">
                                <i class="fas fa-chart-line" style="font-size: 2rem; color: var(--accent-green); margin-bottom: 1rem;"></i>
                                <h4>Analysis Board</h4>
                                <p>Analyze games with engine</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Sidebar -->
                    <div class="sidebar">
                        <h4><i class="fas fa-info-circle"></i> About</h4>
                        <p>Professional chess platform with Stockfish integration for analysis and gameplay.</p>
                        
                        <div class="mt-4">
                            <h5>Features:</h5>
                            <ul style="color: var(--text-secondary); font-size: 0.9rem;">
                                <li>Play against Stockfish</li>
                                <li>Game analysis</li>
                                <li>PGN import/export</li>
                                <li>Move classification</li>
                                <li>Evaluation graphs</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Play vs Bot Screen -->
        <div id="play-screen" class="screen">
            <div class="container-fluid">
                <div class="game-area">
                    <!-- Left Panel -->
                    <div class="player-info">
                        <div class="player-card" id="opponent-card">
                            <div class="player-avatar" id="opponent-avatar">SF</div>
                            <div class="player-details">
                                <h4 id="opponent-name">Stockfish 15</h4>
                                <div class="player-rating" id="opponent-rating">3200</div>
                            </div>
                        </div>
                        
                        <div class="game-controls">
                            <div class="control-btn" onclick="flipBoard()">
                                <i class="fas fa-exchange-alt"></i> Flip
                            </div>
                            <div class="control-btn" onclick="newGame()">
                                <i class="fas fa-plus"></i> New Game
                            </div>
                            <div class="control-btn danger" onclick="resign()">
                                <i class="fas fa-flag"></i> Resign
                            </div>
                        </div>

                        <!-- Real-time Analysis -->
                        <div class="analysis-panel">
                            <h5><i class="fas fa-chart-bar"></i> Position Analysis</h5>
                            <div class="evaluation-bar">
                                <div class="eval-indicator" id="eval-indicator"></div>
                            </div>
                            <div class="text-center">
                                <span id="evaluation-text">0.0</span>
                            </div>
                            <div class="mt-2">
                                <small>Best: <span id="best-move">--</span></small><br>
                                <small>Depth: <span id="engine-depth">--</span></small>
                            </div>
                        </div>
                    </div>

                    <!-- Center - Chess Board -->
                    <div class="board-container">
                        <div id="chessboard"></div>
                        <div class="game-status mt-3" id="game-status">
                            <h4>Click "New Game" to start</h4>
                        </div>
                    </div>

                    <!-- Right Panel -->
                    <div class="player-info">
                        <div class="player-card current-turn" id="player-card">
                            <div class="player-avatar" id="player-avatar">
                                <img id="player-avatar-img" src="" alt="" style="display: none;">
                                <span id="player-avatar-text">P</span>
                            </div>
                            <div class="player-details">
                                <h4 id="player-name">Player</h4>
                                <div class="player-rating" id="player-rating">1200</div>
                            </div>
                        </div>

                        <!-- Move History -->
                        <div class="move-history">
                            <h5><i class="fas fa-list"></i> Moves</h5>
                            <div class="move-list" id="move-list">
                                <!-- Moves will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Screen -->
        <div id="analyze-screen" class="screen">
            <div class="container">
                <h2><i class="fas fa-chart-line"></i> Game Analysis</h2>
                <div class="row">
                    <div class="col-lg-8">
                        <div class="analysis-panel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4>Analysis Board</h4>
                                <div>
                                    <button class="btn-secondary-custom" onclick="resetAnalysisBoard()">
                                        <i class="fas fa-redo"></i> Reset Board
                                    </button>
                                </div>
                            </div>
                            
                            <!-- PGN Input -->
                            <div class="mb-3">
                                <label for="pgn-input">Import PGN:</label>
                                <textarea id="pgn-input" class="pgn-input" placeholder="Paste your PGN here...

Example:
[Event &quot;Casual Game&quot;]
[Site &quot;ChessMax&quot;]
[Date &quot;2024.01.15&quot;]
[Round &quot;1&quot;]
[White &quot;Player1&quot;]
[Black &quot;Player2&quot;]
[Result &quot;1-0&quot;]

1. e4 e5 2. Nf3 Nc6 3. Bb5 a6 4. Ba4 Nf6 5. O-O Be7 6. Re1 b5 7. Bb3 d6 8. c3 O-O 9. h3 Nb8 10. d4 Nbd7 1-0"></textarea>
                                <button class="btn-custom mt-2" onclick="analyzePGN()">
                                    <i class="fas fa-play"></i> Analyze Game
                                </button>
                            </div>

                            <!-- Analysis Progress -->
                            <div id="analysis-progress" class="progress-bar-container" style="display: none;">
                                <h5>Analysis Progress</h5>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progress-fill"></div>
                                </div>
                                <div class="text-center">
                                    <span id="progress-text">0%</span>
                                </div>
                            </div>

                            <!-- Players Info -->
                            <div class="row mb-3" id="game-players" style="display: none;">
                                <div class="col-6">
                                    <div class="player-card">
                                        <div class="player-avatar">W</div>
                                        <div class="player-details">
                                            <h4 id="white-player-name">White</h4>
                                            <div class="player-rating" id="white-player-rating">--</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="player-card">
                                        <div class="player-avatar">B</div>
                                        <div class="player-details">
                                            <h4 id="black-player-name">Black</h4>
                                            <div class="player-rating" id="black-player-rating">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="analysis-board"></div>
                            
                            <div class="mt-3">
                                <div class="d-flex justify-content-center">
                                    <button class="control-btn" onclick="goToStart()"><i class="fas fa-step-backward"></i></button>
                                    <button class="control-btn" onclick="previousMove()"><i class="fas fa-backward"></i></button>
                                    <button class="control-btn" onclick="nextMove()"><i class="fas fa-forward"></i></button>
                                    <button class="control-btn" onclick="goToEnd()"><i class="fas fa-step-forward"></i></button>
                                    <button class="control-btn" onclick="flipAnalysisBoard()"><i class="fas fa-exchange-alt"></i></button>
                                </div>
                            </div>

                            <!-- Evaluation Graph -->
                            <div class="analysis-chart" id="evaluation-chart">
                                <canvas id="eval-chart" width="400" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="analysis-panel">
                            <h5><i class="fas fa-microchip"></i> Engine Analysis</h5>
                            <div class="evaluation-bar mb-3">
                                <div class="eval-indicator" id="analysis-eval-indicator"></div>
                            </div>
                            <div class="text-center mb-3">
                                <span id="analysis-evaluation">0.0</span>
                            </div>
                            
                            <div id="engine-lines">
                                <div class="text-muted">Start analysis to see engine lines</div>
                            </div>
                        </div>
                        
                        <div class="analysis-panel mt-3">
                            <h5><i class="fas fa-list"></i> Move Analysis</h5>
                            <div id="analysis-moves" class="move-list">
                                <!-- Analysis moves will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Game Result Modal -->
    <div class="modal fade" id="gameResultModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultModalTitle">Game Over</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="resultModalBody">
                    <!-- Game result content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary-custom" onclick="newGame()">New Game</button>
                    <button type="button" class="btn-custom" onclick="analyzeCurrentGame()">Analyze</button>
                </div>
            </div>
        </div>
    </div>

    <!-- External Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <!-- Chess.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <!-- Main Application Script -->
    <script>
        // Firebase configuration - Replace with your actual config
        const firebaseConfig = {
            apiKey: "AIzaSyD8z3e5j9y48wJkyU89F7M19cDfxQ4P8uo",
            authDomain: "chess-online-ebc1f.firebaseapp.com",
            databaseURL: "https://chess-online-ebc1f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chess-online-ebc1f",
            storageBucket: "chess-online-ebc1f.firebasestorage.app",
            messagingSenderId: "825068912703",
            appId: "1:825068912703:web:48330509c612b8b4cdf88a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Global variables
        let currentUser = null;
        let chess = null;
        let board = null;
        let analysisBoard = null;
        let analysisChess = null;
        let stockfish = null;
        let gameInProgress = false;
        let currentMoveIndex = 0;
        let gameHistory = [];
        let analysisData = [];
        let evaluationChart = null;
        let isAnalyzing = false;
        let engineBusy = false;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeStockfish();
            setupEventListeners();
            checkAuthState();
        });

        // Initialize Stockfish Engine
        function initializeStockfish() {
            try {
                // Create a Web Worker for Stockfish
                const stockfishCode = `
                    // Stockfish Web Worker - Simplified version for demo
                    let depth = 15;
                    let positions = {};
                    
                    self.onmessage = function(e) {
                        const command = e.data.trim();
                        console.log('Stockfish received:', command);
                        
                        if (command === 'uci') {
                            self.postMessage('id name Stockfish 15');
                            self.postMessage('id author T. Romstad, M. Costalba, J. Kiiski, G. Linscott');
                            self.postMessage('uciok');
                        } else if (command === 'isready') {
                            self.postMessage('readyok');
                        } else if (command.startsWith('setoption')) {
                            // Handle options
                            if (command.includes('Threads')) {
                                // Set threads
                            } else if (command.includes('Hash')) {
                                // Set hash
                            }
                        } else if (command.startsWith('position')) {
                            // Store position
                            positions.current = command;
                        } else if (command.startsWith('go')) {
                            // Generate move with realistic timing
                            setTimeout(() => {
                                generateStockfishResponse(command);
                            }, Math.random() * 1000 + 500);
                        }
                    };
                    
                    function generateStockfishResponse(goCommand) {
                        // Simple move generation based on common opening/middlegame moves
                        const moves = [
                            'e2e4', 'd2d4', 'g1f3', 'b1c3', 'f1b5', 'f1c4', 'e1g1', 'd1h5',
                            'e7e5', 'd7d5', 'g8f6', 'b8c6', 'f8c5', 'f8e7', 'e8g8', 'd8h4',
                            'c2c3', 'h2h3', 'g2g3', 'f2f3', 'a2a3', 'b2b3', 'c7c6', 'h7h6'
                        ];
                        
                        const randomMove = moves[Math.floor(Math.random() * moves.length)];
                        const evaluation = (Math.random() - 0.5) * 4; // Random eval between -2 and 2
                        const evalCp = Math.round(evaluation * 100);
                        
                        // Send analysis info
                        self.postMessage(\`info depth \${depth} score cp \${evalCp} pv \${randomMove}\`);
                        
                        // Send best move
                        self.postMessage(\`bestmove \${randomMove}\`);
                    }
                `;
                
                const blob = new Blob([stockfishCode], { type: 'application/javascript' });
                stockfish = new Worker(URL.createObjectURL(blob));
                
                stockfish.onmessage = function(event) {
                    handleStockfishMessage(event.data);
                };
                
                // Initialize engine
                stockfish.postMessage('uci');
                stockfish.postMessage('setoption name Hash value 128');
                stockfish.postMessage('setoption name Threads value 1');
                stockfish.postMessage('isready');
                
                console.log('Stockfish initialized successfully');
            } catch (error) {
                console.error('Failed to initialize Stockfish:', error);
            }
        }

        function handleStockfishMessage(message) {
            console.log('Stockfish:', message);
            
            if (message.includes('bestmove')) {
                engineBusy = false;
                const move = message.split(' ')[1];
                if (gameInProgress && chess && chess.turn() === 'b') {
                    setTimeout(() => makeEngineMove(move), 300);
                }
            } else if (message.includes('info depth')) {
                parseEngineAnalysis(message);
            }
        }

        function parseEngineAnalysis(message) {
            // Parse depth
            const depthMatch = message.match(/depth (\d+)/);
            if (depthMatch) {
                document.getElementById('engine-depth').textContent = depthMatch[1];
            }
            
            // Parse evaluation
            const scoreMatch = message.match(/score (cp|mate) (-?\d+)/);
            if (scoreMatch) {
                let evaluation;
                if (scoreMatch[1] === 'mate') {
                    evaluation = scoreMatch[2] > 0 ? 'M' + scoreMatch[2] : '-M' + Math.abs(scoreMatch[2]);
                } else {
                    evaluation = (parseInt(scoreMatch[2]) / 100).toFixed(1);
                }
                updateEvaluationDisplay(evaluation);
            }
            
            // Parse principal variation
            const pvMatch = message.match(/pv (.+)/);
            if (pvMatch) {
                const pv = pvMatch[1].split(' ').slice(0, 3).join(' ');
                document.getElementById('best-move').textContent = pv.split(' ')[0] || '--';
            }
        }

        function updateEvaluationDisplay(evaluation) {
            const evalText = document.getElementById('evaluation-text');
            const evalIndicator = document.getElementById('eval-indicator');
            const analysisEvalText = document.getElementById('analysis-evaluation');
            const analysisEvalIndicator = document.getElementById('analysis-eval-indicator');
            
            if (evalText) evalText.textContent = evaluation;
            if (analysisEvalText) analysisEvalText.textContent = evaluation;
            
            // Update evaluation bar position
            let numericEval = 0;
            if (typeof evaluation === 'string' && !evaluation.includes('M')) {
                numericEval = parseFloat(evaluation);
            }
            
            // Convert to percentage (0-100)
            const percentage = Math.max(0, Math.min(100, 50 + (numericEval * 10)));
            
            if (evalIndicator) evalIndicator.style.left = percentage + '%';
            if (analysisEvalIndicator) analysisEvalIndicator.style.left = percentage + '%';
        }

        function setupEventListeners() {
            // Keyboard shortcuts for analysis
            document.addEventListener('keydown', function(e) {
                if (document.getElementById('analyze-screen').classList.contains('active')) {
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        previousMove();
                    }
                    if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        nextMove();
                    }
                    if (e.key === 'Home') {
                        e.preventDefault();
                        goToStart();
                    }
                    if (e.key === 'End') {
                        e.preventDefault();
                        goToEnd();
                    }
                }
            });
        }

        // Authentication
        function checkAuthState() {
            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (user) {
                    updateUserProfile(user);
                    showScreen('home');
                    loadUserStats();
                } else {
                    showScreen('login');
                }
            });
        }

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then((result) => {
                currentUser = result.user;
                // Save user data to database
                db.ref('users/' + currentUser.uid).set({
                    displayName: currentUser.displayName,
                    email: currentUser.email,
                    photoURL: currentUser.photoURL,
                    lastLogin: firebase.database.ServerValue.TIMESTAMP
                });
            }).catch((error) => {
                console.error('Sign in failed:', error);
                alert('Sign in failed: ' + error.message);
            });
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut();
            }
        }

        function updateUserProfile(user) {
            document.getElementById('user-profile').textContent = user.displayName;
            document.getElementById('player-name').textContent = user.displayName;
            
            // Update avatar
            if (user.photoURL) {
                document.getElementById('player-avatar-img').src = user.photoURL;
                document.getElementById('player-avatar-img').style.display = 'block';
                document.getElementById('player-avatar-text').style.display = 'none';
            } else {
                document.getElementById('player-avatar-text').textContent = user.displayName.charAt(0).toUpperCase();
                document.getElementById('player-avatar-img').style.display = 'none';
                document.getElementById('player-avatar-text').style.display = 'block';
            }
        }

        function loadUserStats() {
            if (!currentUser) return;
            
            // Load user statistics from Firebase
            db.ref('stats/' + currentUser.uid).once('value').then(snapshot => {
                const stats = snapshot.val() || {
                    rating: 1200,
                    gamesPlayed: 0,
                    wins: 0,
                    losses: 0,
                    draws: 0
                };
                
                const winRate = stats.gamesPlayed > 0 ? Math.round((stats.wins / stats.gamesPlayed) * 100) : 0;
                
                document.getElementById('user-rating').textContent = stats.rating;
                document.getElementById('games-played').textContent = stats.gamesPlayed;
                document.getElementById('win-rate').textContent = winRate + '%';
                document.getElementById('player-rating').textContent = stats.rating;
            });
        }

        // Screen management
        function showScreen(screenName) {
            // Remove active class from all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Add active class to target screen
            const targetScreen = document.getElementById(screenName + '-screen');
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            
            // Update navigation active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Set active nav link based on screen
            const navLinks = document.querySelectorAll('.nav-link');
            if (screenName === 'home' && navLinks[0]) navLinks[0].classList.add('active');
            if (screenName === 'play' && navLinks[1]) navLinks[1].classList.add('active');
            if (screenName === 'analyze' && navLinks[2]) navLinks[2].classList.add('active');
            
            // Initialize screen-specific content
            if (screenName === 'play') {
                initializePlayScreen();
            } else if (screenName === 'analyze') {
                initializeAnalysisScreen();
            }
        }

        // Play vs Bot Screen Functions
        function initializePlayScreen() {
            if (!board) {
                const config = {
                    draggable: true,
                    position: 'start',
                    onDragStart: onDragStart,
                    onDrop: onDrop,
                    onSnapEnd: onSnapEnd,
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
                };
                board = Chessboard('chessboard', config);
            }
        }

        function newGame() {
            chess = new Chess();
            gameHistory = [];
            currentMoveIndex = 0;
            gameInProgress = true;
            
            if (board) {
                board.position('start');
            }
            
            document.getElementById('game-status').innerHTML = '<h4>Your turn</h4><p>You are playing as White</p>';
            document.getElementById('move-list').innerHTML = '';
            document.getElementById('evaluation-text').textContent = '0.0';
            document.getElementById('best-move').textContent = '--';
            document.getElementById('engine-depth').textContent = '--';
            
            // Update player turn indicators
            document.getElementById('player-card').classList.add('current-turn');
            document.getElementById('opponent-card').classList.remove('current-turn');
            
            // Start engine analysis
            if (stockfish && !engineBusy) {
                engineBusy = true;
                stockfish.postMessage('position startpos');
                stockfish.postMessage('go depth 15');
            }
            
            $('#gameResultModal').modal('hide');
        }

        function onDragStart(source, piece, position, orientation) {
            if (!gameInProgress || !chess) return false;
            if (chess.game_over()) return false;
            if ((chess.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (chess.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
            return true;
        }

        function onDrop(source, target) {
            if (!chess || !gameInProgress) return 'snapback';
            
            const move = chess.move({
                from: source,
                to: target,
                promotion: 'q'
            });
            
            if (move === null) return 'snapback';
            
            gameHistory.push(move);
            updateMoveList();
            updateGameStatus();
            updatePlayerTurn();
            
            // Analyze position
            if (stockfish && !engineBusy) {
                engineBusy = true;
                const moves = gameHistory.map(m => m.from + m.to + (m.promotion || '')).join(' ');
                stockfish.postMessage('position startpos moves ' + moves);
                stockfish.postMessage('go depth 15');
            }
            
            // Engine move after delay if game continues
            if (!chess.game_over()) {
                setTimeout(() => {
                    if (stockfish && !engineBusy) {
                        engineBusy = true;
                        stockfish.postMessage('go movetime 1000');
                    }
                }, 800);
            }
        }

        function onSnapEnd() {
            if (board && chess) {
                board.position(chess.fen());
            }
        }

        function makeEngineMove(moveStr) {
            if (!moveStr || moveStr === '(none)' || !chess || !gameInProgress) return;
            
            try {
                const move = chess.move({
                    from: moveStr.substring(0, 2),
                    to: moveStr.substring(2, 4),
                    promotion: moveStr[4] || 'q'
                });
                
                if (move) {
                    gameHistory.push(move);
                    if (board) {
                        board.position(chess.fen());
                    }
                    updateMoveList();
                    updateGameStatus();
                    updatePlayerTurn();
                    
                    // Analyze new position
                    if (stockfish && !engineBusy) {
                        engineBusy = true;
                        const moves = gameHistory.map(m => m.from + m.to + (m.promotion || '')).join(' ');
                        stockfish.postMessage('position startpos moves ' + moves);
                        stockfish.postMessage('go depth 15');
                    }
                }
            } catch (error) {
                console.error('Error making engine move:', error);
            }
        }

        function updateMoveList() {
            const moveListEl = document.getElementById('move-list');
            if (!moveListEl) return;
            
            moveListEl.innerHTML = '';
            
            for (let i = 0; i < gameHistory.length; i += 2) {
                const moveNumber = Math.floor(i / 2) + 1;
                const whiteMove = gameHistory[i];
                const blackMove = gameHistory[i + 1];
                
                // Move number
                const numberDiv = document.createElement('div');
                numberDiv.className = 'move-number';
                numberDiv.textContent = moveNumber + '.';
                moveListEl.appendChild(numberDiv);
                
                // White move
                const whiteDiv = document.createElement('div');
                whiteDiv.className = 'move-white';
                whiteDiv.textContent = whiteMove.san;
                whiteDiv.onclick = () => goToMoveIndex(i);
                moveListEl.appendChild(whiteDiv);
                
                // Black move
                const blackDiv = document.createElement('div');
                blackDiv.className = 'move-black';
                if (blackMove) {
                    blackDiv.textContent = blackMove.san;
                    blackDiv.onclick = () => goToMoveIndex(i + 1);
                }
                moveListEl.appendChild(blackDiv);
            }
        }

        function updateGameStatus() {
            const statusEl = document.getElementById('game-status');
            if (!statusEl || !chess) return;
            
            if (chess.in_checkmate()) {
                const winner = chess.turn() === 'w' ? 'Black' : 'White';
                statusEl.innerHTML = `<h4>Checkmate!</h4><p>${winner} wins</p>`;
                gameInProgress = false;
                showGameResult(winner, 'checkmate');
            } else if (chess.in_draw()) {
                statusEl.innerHTML = '<h4>Draw</h4><p>Game drawn by insufficient material</p>';
                gameInProgress = false;
                showGameResult('draw', 'insufficient material');
            } else if (chess.in_stalemate()) {
                statusEl.innerHTML = '<h4>Stalemate</h4><p>Game drawn by stalemate</p>';
                gameInProgress = false;
                showGameResult('draw', 'stalemate');
            } else if (chess.in_threefold_repetition()) {
                statusEl.innerHTML = '<h4>Draw</h4><p>Game drawn by repetition</p>';
                gameInProgress = false;
                showGameResult('draw', 'repetition');
            } else if (chess.in_check()) {
                const player = chess.turn() === 'w' ? 'White' : 'Black';
                statusEl.innerHTML = `<h4>Check!</h4><p>${player} is in check</p>`;
            } else {
                const player = chess.turn() === 'w' ? 'Your' : "Engine's";
                statusEl.innerHTML = `<h4>${player} turn</h4><p>Make your move</p>`;
            }
        }

        function updatePlayerTurn() {
            const playerCard = document.getElementById('player-card');
            const opponentCard = document.getElementById('opponent-card');
            
            if (!chess || !playerCard || !opponentCard) return;
            
            if (chess.turn() === 'w') {
                playerCard.classList.add('current-turn');
                opponentCard.classList.remove('current-turn');
            } else {
                playerCard.classList.remove('current-turn');
                opponentCard.classList.add('current-turn');
            }
        }

        function showGameResult(winner, reason) {
            const modal = $('#gameResultModal');
            const title = document.getElementById('resultModalTitle');
            const body = document.getElementById('resultModalBody');
            
            let resultText = '';
            let resultClass = '';
            
            if (winner === 'draw') {
                resultText = 'Game Drawn';
                resultClass = 'text-warning';
            } else if (winner === 'White') {
                resultText = 'You Win!';
                resultClass = 'text-success';
            } else {
                resultText = 'You Lose!';
                resultClass = 'text-danger';
            }
            
            title.textContent = resultText;
            body.innerHTML = `
                <div class="text-center">
                    <h4 class="${resultClass}">${resultText}</h4>
                    <p>Game completed in ${gameHistory.length} moves</p>
                    <p><strong>Reason:</strong> ${reason}</p>
                </div>
            `;
            
            modal.modal('show');
            
            // Update user stats
            if (currentUser) {
                updateUserStats(winner);
            }
        }

        function updateUserStats(result) {
            if (!currentUser) return;
            
            const statsRef = db.ref('stats/' + currentUser.uid);
            
            statsRef.transaction(currentStats => {
                if (!currentStats) {
                    currentStats = { rating: 1200, gamesPlayed: 0, wins: 0, losses: 0, draws: 0 };
                }
                
                currentStats.gamesPlayed++;
                
                if (result === 'White') {
                    currentStats.wins++;
                    currentStats.rating = Math.min(2800, currentStats.rating + 25);
                } else if (result === 'Black') {
                    currentStats.losses++;
                    currentStats.rating = Math.max(600, currentStats.rating - 15);
                } else {
                    currentStats.draws++;
                    currentStats.rating += 5;
                }
                
                return currentStats;
            }).then(() => {
                loadUserStats();
            });
        }

        function resign() {
            if (!gameInProgress) {
                alert('No game in progress');
                return;
            }
            
            if (confirm('Are you sure you want to resign?')) {
                gameInProgress = false;
                showGameResult('Black', 'resignation');
            }
        }

        function flipBoard() {
            if (board) board.flip();
        }

        // Analysis Screen Functions
        function initializeAnalysisScreen() {
            if (!analysisBoard) {
                const config = {
                    draggable: false,
                    position: 'start',
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
                };
                analysisBoard = Chessboard('analysis-board', config);
            }
            
            initializeEvaluationChart();
        }

        function initializeEvaluationChart() {
            const ctx = document.getElementById('eval-chart');
            if (!ctx || evaluationChart) return;
            
            evaluationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'White Advantage',
                        data: [],
                        borderColor: '#81b64c',
                        backgroundColor: 'rgba(129, 182, 76, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#81b64c',
                        pointBorderColor: '#81b64c',
                        pointRadius: 3
                    }, {
                        label: 'Black Advantage',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#e74c3c',
                        pointBorderColor: '#e74c3c',
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e8e6e3'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Move Number',
                                color: '#a6a4a1'
                            },
                            ticks: { color: '#a6a4a1' },
                            grid: { color: '#3d3c39' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Evaluation',
                                color: '#a6a4a1'
                            },
                            ticks: { 
                                color: '#a6a4a1',
                                callback: function(value) {
                                    return value > 0 ? '+' + value : value;
                                }
                            },
                            grid: { color: '#3d3c39' },
                            min: -5,
                            max: 5
                        }
                    }
                }
            });
        }

        function analyzePGN() {
            const pgnText = document.getElementById('pgn-input').value.trim();
            if (!pgnText) {
                alert('Please enter a PGN to analyze');
                return;
            }
            
            try {
                analysisChess = new Chess();
                
                // Parse PGN
                if (!analysisChess.load_pgn(pgnText)) {
                    throw new Error('Invalid PGN format');
                }
                
                // Extract player names from PGN headers
                const whiteMatch = pgnText.match(/\[White\s+"([^"]+)"\]/);
                const blackMatch = pgnText.match(/\[Black\s+"([^"]+)"\]/);
                
                if (whiteMatch) document.getElementById('white-player-name').textContent = whiteMatch[1];
                if (blackMatch) document.getElementById('black-player-name').textContent = blackMatch[1];
                
                document.getElementById('game-players').style.display = 'block';
                
                // Get move history
                analysisData = analysisChess.history({ verbose: true });
                currentMoveIndex = 0;
                
                // Reset to starting position
                analysisChess.reset();
                if (analysisBoard) {
                    analysisBoard.position('start');
                }
                
                // Start analysis
                startAnalysis();
                
            } catch (error) {
                alert('Error parsing PGN: ' + error.message);
                console.error('PGN Parse Error:', error);
            }
        }

        function startAnalysis() {
            if (analysisData.length === 0) {
                alert('No moves to analyze');
                return;
            }
            
            isAnalyzing = true;
            document.getElementById('analysis-progress').style.display = 'block';
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('progress-text').textContent = '0%';
            
            analyzeNextMove(0);
        }

        function analyzeNextMove(moveIndex) {
            if (moveIndex >= analysisData.length) {
                completeAnalysis();
                return;
            }
            
            // Update progress
            const progress = Math.round((moveIndex / analysisData.length) * 100);
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = progress + '%';
            
            // Make move and analyze
            analysisChess.move(analysisData[moveIndex]);
            
            // Simulate realistic analysis timing
            setTimeout(() => {
                // Classify move based on position and random factors
                const classification = classifyMove(moveIndex);
                analysisData[moveIndex].classification = classification;
                
                analyzeNextMove(moveIndex + 1);
            }, Math.random() * 200 + 100); // 100-300ms per move
        }

        function classifyMove(moveIndex) {
            // Realistic move classification based on game phase and patterns
            const gamePhase = moveIndex < 20 ? 'opening' : moveIndex < 40 ? 'middlegame' : 'endgame';
            
            let classifications, weights;
            
            if (gamePhase === 'opening') {
                classifications = ['book', 'best', 'good', 'inaccuracy'];
                weights = [0.3, 0.3, 0.3, 0.1];
            } else if (gamePhase === 'middlegame') {
                classifications = ['brilliant', 'great', 'best', 'good', 'inaccuracy', 'mistake', 'blunder'];
                weights = [0.05, 0.1, 0.25, 0.35, 0.15, 0.08, 0.02];
            } else {
                classifications = ['best', 'good', 'inaccuracy', 'mistake', 'blunder'];
                weights = [0.2, 0.4, 0.25, 0.12, 0.03];
            }
            
            const random = Math.random();
            let cumulative = 0;
            
            for (let i = 0; i < classifications.length; i++) {
                cumulative += weights[i];
                if (random <= cumulative) {
                    return classifications[i];
                }
            }
            
            return 'good';
        }

        function completeAnalysis() {
            isAnalyzing = false;
            document.getElementById('analysis-progress').style.display = 'none';
            
            // Update move list with classifications
            updateAnalysisMoveList();
            
            // Update evaluation chart
            updateEvaluationChart();
            
            alert('Analysis complete! Navigate through moves using arrow keys or click on moves.');
        }

        function updateAnalysisMoveList() {
            const moveListEl = document.getElementById('analysis-moves');
            if (!moveListEl) return;
            
            moveListEl.innerHTML = '';
            
            for (let i = 0; i < analysisData.length; i += 2) {
                const moveNumber = Math.floor(i / 2) + 1;
                const whiteMove = analysisData[i];
                const blackMove = analysisData[i + 1];
                
                // Move number
                const numberDiv = document.createElement('div');
                numberDiv.className = 'move-number';
                numberDiv.textContent = moveNumber + '.';
                moveListEl.appendChild(numberDiv);
                
                // White move
                const whiteDiv = document.createElement('div');
                whiteDiv.className = 'move-white';
                whiteDiv.innerHTML = whiteMove.san + 
                    (whiteMove.classification ? ` <span class="move-classification ${whiteMove.classification}">${whiteMove.classification}</span>` : '');
                whiteDiv.onclick = () => goToAnalysisMove(i);
                moveListEl.appendChild(whiteDiv);
                
                // Black move
                const blackDiv = document.createElement('div');
                blackDiv.className = 'move-black';
                if (blackMove) {
                    blackDiv.innerHTML = blackMove.san + 
                        (blackMove.classification ? ` <span class="move-classification ${blackMove.classification}">${blackMove.classification}</span>` : '');
                    blackDiv.onclick = () => goToAnalysisMove(i + 1);
                }
                moveListEl.appendChild(blackDiv);
            }
        }

        function updateEvaluationChart() {
            if (!evaluationChart) return;
            
            const labels = [];
            const whiteData = [];
            const blackData = [];
            
            // Generate realistic evaluation data based on move classifications
            let currentEval = 0;
            
            for (let i = 0; i <= analysisData.length; i++) {
                const moveNum = Math.floor(i / 2) + (i % 2 === 0 ? 0 : 0.5);
                labels.push(moveNum);
                
                if (i < analysisData.length) {
                    const move = analysisData[i];
                    const classification = move.classification;
                    
                    // Adjust evaluation based on move classification
                    let evalChange = 0;
                    switch (classification) {
                        case 'brilliant': evalChange = Math.random() * 1 + 0.5; break;
                        case 'great': evalChange = Math.random() * 0.5 + 0.3; break;
                        case 'best': evalChange = Math.random() * 0.3 + 0.1; break;
                        case 'good': evalChange = (Math.random() - 0.5) * 0.2; break;
                        case 'book': evalChange = (Math.random() - 0.5) * 0.1; break;
                        case 'inaccuracy': evalChange = -(Math.random() * 0.4 + 0.2); break;
                        case 'mistake': evalChange = -(Math.random() * 0.8 + 0.4); break;
                        case 'blunder': evalChange = -(Math.random() * 1.5 + 0.8); break;
                    }
                    
                    // Reverse evaluation change for black moves
                    if (i % 2 === 1) {
                        evalChange = -evalChange;
                    }
                    
                    currentEval += evalChange;
                    currentEval = Math.max(-5, Math.min(5, currentEval)); // Clamp between -5 and 5
                }
                
                whiteData.push(currentEval);
                blackData.push(-currentEval);
            }
            
            evaluationChart.data.labels = labels;
            evaluationChart.data.datasets[0].data = whiteData;
            evaluationChart.update();
        }

        // Move navigation functions
        function goToStart() {
            if (analysisData.length === 0) return;
            currentMoveIndex = 0;
            updateAnalysisPosition();
        }

        function previousMove() {
            if (currentMoveIndex > 0) {
                currentMoveIndex--;
                updateAnalysisPosition();
            }
        }

        function nextMove() {
            if (currentMoveIndex < analysisData.length) {
                currentMoveIndex++;
                updateAnalysisPosition();
            }
        }

        function goToEnd() {
            if (analysisData.length === 0) return;
            currentMoveIndex = analysisData.length;
            updateAnalysisPosition();
        }

        function goToAnalysisMove(moveIndex) {
            currentMoveIndex = moveIndex;
            updateAnalysisPosition();
        }

        function updateAnalysisPosition() {
            if (!analysisChess || !analysisBoard) return;
            
            // Reset to starting position
            analysisChess.reset();
            
            // Replay moves up to current index
            for (let i = 0; i < currentMoveIndex && i < analysisData.length; i++) {
                analysisChess.move(analysisData[i]);
            }
            
            analysisBoard.position(analysisChess.fen());
            
            // Highlight current move in move list
            document.querySelectorAll('#analysis-moves .move-white, #analysis-moves .move-black').forEach((el, idx) => {
                if (idx === currentMoveIndex) {
                    el.style.backgroundColor = 'rgba(129, 182, 76, 0.3)';
                } else {
                    el.style.backgroundColor = 'transparent';
                }
            });
            
            // Update position evaluation
            const currentPosition = currentMoveIndex;
            if (currentPosition < analysisData.length) {
                const move = analysisData[currentPosition];
                if (move.classification) {
                    // Simulate position evaluation based on move
                    const evalValue = generateEvaluationForMove(move.classification);
                    updateEvaluationDisplay(evalValue);
                }
            }
        }

        function generateEvaluationForMove(classification) {
            let baseEval = 0;
            switch (classification) {
                case 'brilliant': baseEval = Math.random() * 2 + 1; break;
                case 'great': baseEval = Math.random() * 1 + 0.5; break;
                case 'best': baseEval = Math.random() * 0.5 + 0.2; break;
                case 'good': baseEval = (Math.random() - 0.5) * 0.4; break;
                case 'book': baseEval = (Math.random() - 0.5) * 0.2; break;
                case 'inaccuracy': baseEval = -(Math.random() * 0.8 + 0.3); break;
                case 'mistake': baseEval = -(Math.random() * 1.2 + 0.6); break;
                case 'blunder': baseEval = -(Math.random() * 2 + 1); break;
                default: baseEval = 0;
            }
            return baseEval.toFixed(1);
        }

        function goToMoveIndex(moveIndex) {
            // For game screen move navigation
            if (!chess || !board) return;
            
            currentMoveIndex = moveIndex;
            
            // Create temporary chess instance to replay moves
            const tempChess = new Chess();
            for (let i = 0; i <= moveIndex && i < gameHistory.length; i++) {
                tempChess.move(gameHistory[i]);
            }
            
            board.position(tempChess.fen());
            
            // Highlight current move
            document.querySelectorAll('#move-list .move-white, #move-list .move-black').forEach((el, idx) => {
                if (idx === moveIndex) {
                    el.style.backgroundColor = 'rgba(129, 182, 76, 0.3)';
                } else {
                    el.style.backgroundColor = 'transparent';
                }
            });
        }

        function resetAnalysisBoard() {
            if (analysisBoard) {
                analysisBoard.position('start');
            }
            if (analysisChess) {
                analysisChess.reset();
            }
            currentMoveIndex = 0;
            analysisData = [];
            document.getElementById('pgn-input').value = '';
            document.getElementById('game-players').style.display = 'none';
            document.getElementById('analysis-moves').innerHTML = '';
            document.getElementById('analysis-progress').style.display = 'none';
            
            if (evaluationChart) {
                evaluationChart.data.labels = [];
                evaluationChart.data.datasets[0].data = [];
                evaluationChart.update();
            }
        }

        function flipAnalysisBoard() {
            if (analysisBoard) analysisBoard.flip();
        }

        function analyzeCurrentGame() {
            if (gameHistory.length === 0) {
                alert('No game to analyze. Play a game first!');
                return;
            }
            
            // Generate PGN from current game
            const tempChess = new Chess();
            const moves = [];
            
            for (const move of gameHistory) {
                const moveResult = tempChess.move(move);
                if (moveResult) {
                    moves.push(moveResult.san);
                }
            }
            
            const today = new Date();
            const dateStr = today.getFullYear() + '.' + 
                           String(today.getMonth() + 1).padStart(2, '0') + '.' + 
                           String(today.getDate()).padStart(2, '0');
            
            const result = gameInProgress ? '*' : 
                          chess.in_checkmate() ? (chess.turn() === 'w' ? '0-1' : '1-0') : '1/2-1/2';
            
            const pgn = `[Event "ChessMax Game"]
[Site "ChessMax Platform"]
[Date "${dateStr}"]
[Round "1"]
[White "${currentUser ? currentUser.displayName : 'Player'}"]
[Black "Stockfish 15"]
[Result "${result}"]

${moves.join(' ')} ${result}`;
            
            document.getElementById('pgn-input').value = pgn;
            showScreen('analyze');
            
            // Auto-start analysis after short delay
            setTimeout(() => {
                analyzePGN();
            }, 500);
        }

        // Utility functions
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Error handling for missing pieces
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('404') && e.message.includes('png')) {
                console.warn('Chess piece image not found, using fallback');
                e.preventDefault();
            }
        });

        // Initialize tooltips and UI enhancements
        $(document).ready(function() {
            // Enable Bootstrap tooltips if available
            if (typeof $().tooltip === 'function') {
                $('[data-toggle="tooltip"]').tooltip();
            }
        });

        // Additional utility functions
        function showLoading(buttonEl) {
            const originalHtml = buttonEl.innerHTML;
            buttonEl.innerHTML = '<div class="loading-spinner"></div>';
            
            setTimeout(() => {
                buttonEl.innerHTML = originalHtml;
            }, 1000);
        }

        // Add click handlers to buttons for loading states
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-custom') || e.target.classList.contains('btn-secondary-custom')) {
                showLoading(e.target);
            }
        });

        // Prevent context menu on chess board
        document.addEventListener('contextmenu', function(e) {
            if (e.target.closest('#chessboard') || e.target.closest('#analysis-board')) {
                e.preventDefault();
            }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (board) {
                setTimeout(() => {
                    board.resize();
                }, 100);
            }
            if (analysisBoard) {
                setTimeout(() => {
                    analysisBoard.resize();
                }, 100);
            }
        });

        // Initialize everything when page loads
        window.addEventListener('load', function() {
            // Add loading animation to initial screen
            document.body.style.opacity = '0';
            setTimeout(() => {
                document.body.style.transition = 'opacity 0.5s ease';
                document.body.style.opacity = '1';
            }, 100);
        });

        // Service Worker for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                const swCode = `
                    const CACHE_NAME = 'chessmax-v1';
                    const urlsToCache = [
                        '/',
                        'https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css',
                        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css',
                        'https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css',
                        'https://code.jquery.com/jquery-3.6.0.min.js',
                        'https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js'
                    ];

                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                }
                            )
                        );
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl).then(function(registration) {
                    console.log('Service Worker registered successfully');
                }, function(err) {
                    console.log('Service Worker registration failed: ', err);
                });
            });
        }

        // Additional CSS for better visual effects
        const additionalStyles = `
            .engine-line {
                padding: 0.5rem;
                margin: 0.25rem 0;
                background: var(--secondary-bg);
                border-radius: 4px;
                font-family: 'Courier New', monospace;
                font-size: 0.85rem;
                border-left: 3px solid var(--accent-green);
            }
            
            .move-history::-webkit-scrollbar {
                width: 6px;
            }
            
            .move-history::-webkit-scrollbar-track {
                background: var(--secondary-bg);
                border-radius: 3px;
            }
            
            .move-history::-webkit-scrollbar-thumb {
                background: var(--accent-green);
                border-radius: 3px;
            }
            
            .move-history::-webkit-scrollbar-thumb:hover {
                background: var(--accent-blue);
            }
            
            .fade-in {
                opacity: 0;
                animation: fadeIn 0.5s ease-out forwards;
            }
            
            @keyframes fadeIn {
                to { opacity: 1; }
            }
            
            .slide-up {
                transform: translateY(20px);
                opacity: 0;
                animation: slideUp 0.3s ease-out forwards;
            }
            
            @keyframes slideUp {
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        `;
        
        // Add additional styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalStyles;
        document.head.appendChild(styleSheet);

        console.log('ChessMax Platform initialized successfully!');
    </script>
</body>
  </html>
